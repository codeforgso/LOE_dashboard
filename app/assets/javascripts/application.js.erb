// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/rails/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require turbolinks
//= require bootstrap-sprockets
//= require bootstrap-datepicker/core
//= require bootstrap3-typeahead
//= require_tree .

// necessary to get routes to paths
<% environment.context_class.instance_eval { include Rails.application.routes.url_helpers; require 'dotenv'; Dotenv.load }
%>


var App = window.App || {};
App.urls = {
  cases: {
    autocomplete: '<%= url_for(autocomplete_cases_path) %>'
  }
};
App.google_maps_api_key = '<%= ENV['GOOGLE_MAPS_API_KEY'] %>';
(function($, undefined) {
  App.init = function() {
    Turbolinks.enableProgressBar();
    App.setup_autocomplete();
    App.setup_tabs();
    App.setup_google_maps();
  }

  App.setup_autocomplete = function() {
    $.each($("[data-autocomplete]"),function(i, item) {
      var item_sel = $(item);
      var form = item_sel.parentsUntil("form").parent('form');
      var controller = form.attr('action').split("/")[1];
      var url = App.urls[controller].autocomplete+'?param='+item_sel.data('autocompleteParam');
      item_sel.typeahead({
        delay: 100,
        source: function(query, process) {
          $.getJSON(
            url+'&q='+query,
            function(data) {
              return process(data);
            }
          );
        }
      });
    });
  }

  App.setup_tabs = function() {
    $("ul.nav-tabs a").click(function(e) {
      e.preventDefault();
      $(this).tab('show');
    });
  }

  App.setup_google_maps = function() {
    $.each($("[data-google-maps-iframe-wrapper]"), function(i, item) {
      var item_sel = $(item);
      var iframe = document.createElement('iframe');
      iframe.frameBorder=0;
      iframe.id="randomid";
      iframe.setAttribute('class', 'google-maps-iframe');
      iframe.setAttribute("src", "https://www.google.com/maps/embed/v1/place?key="+App.google_maps_api_key+"&q="+item_sel.data('googleMapsQuery'));
      item_sel.html(iframe);
    });
  }

  // this is the Turbolinks event to bind to for page refreshes + DOM ready
  $(document).on('page:change', function(e) {
    App.init();
  });
})(jQuery);